# Architecture: Modular Monolith (NestJS)

## 1. Core Principles

* **Decoupling:** Modules must remain as independent as possible. Inter-module interaction is strictly controlled.
* **Data Access & Source of Truth:**
* The system uses a global `PrismaModule` that exports the `PrismaService`.
* Each module must implement a **Repository** pattern to encapsulate `PrismaService` calls.
* **Strict Rule:** Direct access to `PrismaService` inside Services or accessing Repositories from other modules is **prohibited**.


* **Domain Isolation:** The project uses **custom entities and types** (located in `entities/` and `types/`). Using types automatically generated by `prisma generate` for domain logic is discouraged to keep the core business logic independent of the database schema.
* **Communication Patterns:**
* **Primary (Asynchronous):** Use `EventEmitter2` for decoupled, event-driven communication.
* **Secondary (Synchronous):** Direct `Service` injection is allowed only when immediate feedback/return is strictly required.


* **Type Safety:** The use of the `any` type is **strictly prohibited** within the `/src` directory.

## 2. Directory Structure & Standards

Modules are located directly under `src/`. Each module must follow this file structure:

```text
src/[module-name]/
├── [module-name].docs.ts        # Swagger decorators (applyDecorators)
├── [module-name].controller.ts  # Route orchestration (HTTP)
├── [module-name].module.ts      # NestJS module definition
├── [module-name].repository.ts  # Persistence layer (Prisma wrapper)
├── [module-name].service.ts     # Business logic
├── listeners/                   # Internal event consumers
├── processors/                  # Background tasks (e.g., Trello data import)
├── dto/                         # Data Transfer Objects
├── entities/                    # Domain entity definitions
├── types/                       # TypeScript type definitions
└── interfaces/                  # Contracts and interfaces

```

### 2.1 Documentation & Security

* **Swagger:** Controllers must remain clean. All OpenAPI/Swagger decorators must be abstracted into the `.docs.ts` file.
* **Authentication:** All route protection `Guards` must be centralized and imported from the `auth` module.

## 3. Testing Strategy

* **Unit Tests (`.spec.ts`):**
    * **Targets:** Applied ONLY to `services` and `processors`.
    * **Isolation:** Mandatory use of mocks for `repositories` and any other external dependencies.
    * **Restriction:** Do NOT write unit tests for `listeners`, `controllers`, or `repositories`.


* **Integration Tests (`.test.ts`):**
    * **Targets:** Applied ONLY to `controllers`.
    * **Location:** `/test` folder at the project root.
    * **Objective:** Validate the complete request-response lifecycle, from Auth/Guards to Database persistence.